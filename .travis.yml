language: c++
sudo: false
addons:
  ssh_known_hosts: bdesroch.homenet.org
  apt:
    sources:
    - deadsnakes
    - ubuntu-toolchain-r-test
    - chef-current-precise
    packages:
    - cmake
    - time
    - pkg-config
    - g++-4.8
cache:
  directories:
  - "$HOME/ibex"
  - "$HOME/Downloads"
matrix:
  include:
  # - os: osx
  #   compiler: clang
  - os: linux
    language: python
    python: '3.4'
    compiler: gcc-4.8
  - os: linux
    language: python
    python: '3.5'
    compiler: gcc-4.8

before_install:
- git clone -b update_pybind11 https://github.com/benEnsta/pyIbex.git
- cd pyIbex
- git submodule init
- git submodule update
- cd ..
- mv pyIbex/* .
- openssl aes-256-cbc -K $encrypted_4be9b5ac2573_key -iv $encrypted_4be9b5ac2573_iv
  -in deploy_rsa.enc -out deploy_rsa -d


- if [ $TRAVIS_OS_NAME == osx ]; then brew update && brew install python3; fi
- if [ $TRAVIS_OS_NAME == osx ]; then pip install wheel; fi
- if [ $TRAVIS_OS_NAME == osx ]; then brew install clang-omp; fi
install:
- bash ./travis_script/build_Ibex4pyIbex.sh
- export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:$HOME/ibex
script:
- mkdir build
- cd build
- export version=$(python -c "import sys; print(sys.version[:3])")
- echo $version
- ls ${HOME}/ibex
- ls ${HOME}/ibex/lib
- if [ $TRAVIS_OS_NAME == osx ]; then CC=clang-omp CXX=clang-omp++ cmake -DCMAKE_INSTALL_PREFIX=${HOME}
  -DIBEX_ROOT=${HOME}/ibex -DPYTHON_VERSION=${version} ../ ; fi
- if [ $TRAVIS_OS_NAME == linux ]; then cmake -DCMAKE_INSTALL_PREFIX=${HOME} -DIBEX_ROOT=${HOME}/ibex
  -DPYTHON_VERSION=${version} -DCMAKE_CXX_COMPILER=g++-4.8 ../ ; fi
- make && make install
- make test
- make pip_package
- export wheel_file=$(ls *.whl)
- mv $wheel_file $TRAVIS_BUILD_DIR/$wheel_file
- make package
- export deb_file=$(ls *.deb)
- mv $deb_file $TRAVIS_BUILD_DIR/$deb_file
- ls $TRAVIS_BUILD_DIR

before_deploy:
- eval "$(ssh-agent -s)"
- chmod 600 $TRAVIS_BUILD_DIR/deploy_rsa
- ssh-add $TRAVIS_BUILD_DIR/deploy_rsa

deploy:
  provider: script
  skip_cleanup: true
  script: rsync -e "ssh -p 2229" -r --delete-after --quiet $TRAVIS_BUILD_DIR/$wheel_file git@bdesroch.homenet.org:~/dist
  script: rsync -e "ssh -p 2229" -r --delete-after --quiet $TRAVIS_BUILD_DIR/$deb_file git@bdesroch.homenet.org:~/dist
  on:
    branch: master
